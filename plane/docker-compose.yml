version: "3.7"

x-environment: &env
  # ---- External URL & ports ----
  WEB_URL: http://${DEVICE_DOMAIN_NAME}:8762
  API_BASE_URL: http://${DEVICE_DOMAIN_NAME}:8762
  LIVE_SERVER_SECRET_KEY: $APP_SEED

  NGINX_HOST: ${DEVICE_DOMAIN_NAME}
  NGINX_PORT: 8762

  LISTEN_HTTP_PORT: 8762
  APP_DOMAIN: ${DEVICE_DOMAIN_NAME}:8762
  APP_PROTOCOL: http

  # ---- Bucket name used by frontend for /uploads paths ----
  BUCKET_NAME: uploads

  # ---- API Workers ----
  GUNICORN_WORKERS: 2

  # ---- Database ----
  POSTGRES_DB: plane
  POSTGRES_USER: plane
  POSTGRES_PASSWORD: umbrelplane
  DATABASE_URL: postgresql://plane:umbrelplane@plane_db_1:5432/plane

  # ---- Cache / broker ----
  REDIS_URL: redis://plane_redis_1:6379/0
  RABBITMQ_DEFAULT_USER: plane
  RABBITMQ_DEFAULT_PASS: umbrelplane
  RABBITMQ_DEFAULT_VHOST: plane
  CELERY_BROKER_URL: amqp://plane:umbrelplane@plane_rabbitmq_1:5672/plane

  # ---- Object storage (MinIO; S3-compatible) ----
  USE_MINIO: 1
  AWS_ACCESS_KEY_ID: umbrel
  AWS_SECRET_ACCESS_KEY: $APP_PASSWORD
  AWS_S3_ENDPOINT_URL: http://plane-minio-1:9000
  AWS_S3_BUCKET_NAME: uploads
  FILE_SIZE_LIMIT: 52428800  # 50 MB
  MINIO_ENDPOINT_SSL: 0
  MINIO_ROOT_USER: umbrel
  MINIO_ROOT_PASSWORD: $APP_PASSWORD

  # ---- Django / app ----
  SECRET_KEY: $APP_SEED
  ALLOWED_HOSTS: ${DEVICE_DOMAIN_NAME}
  CORS_ALLOWED_ORIGINS: http://${DEVICE_DOMAIN_NAME}:8762,http://${DEVICE_DOMAIN_NAME}
  CSRF_TRUSTED_ORIGINS: http://${DEVICE_DOMAIN_NAME}:8762,http://${DEVICE_DOMAIN_NAME}
  # optional but often helps behind proxies
  USE_X_FORWARDED_HOST: 1
  SECURE_SSL_REDIRECT: 0
  SESSION_COOKIE_SECURE: 0
  CSRF_COOKIE_SECURE: 0
  ENABLE_SIGNUP: 0
  DEBUG: 0

services:
  app_proxy:
    environment:
      APP_HOST: plane_nginx_1
      APP_PORT: 8762
      PROXY_AUTH_ADD: "false"
  
  nginx:
    image: nginx:alpine3.22@sha256:d67ea0d64d518b1bb04acde3b00f722ac3e9764b3209a9b0a98924ba35e4b779
    restart: on-failure
    volumes:
      - ${APP_DATA_DIR}/config/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - web

  db:
    image: postgres:17.7-alpine@sha256:9a78577340f3d26384b6aebeb475c0d46d664fd4ffa68503b4be4e4462745f94
    user: "1000:1000"
    restart: on-failure
    environment:
      <<: *env
    volumes:
      - ${APP_DATA_DIR}/data/db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 10

  redis:
    image: valkey/valkey:7.2.11-alpine@sha256:7b2019b47ad58be661fa6eba5ea66106eadde03459387113aaed29a464a5876b
    user: "1000:1000"
    restart: on-failure
    volumes:
      - ${APP_DATA_DIR}/data/redis:/data

  rabbitmq:
    image: rabbitmq:3.13.7-management-alpine@sha256:0c64ec4fc5596406d755dcca75e8a3b618192cc5fb69f8f0340f06290b1cc08c
    user: "1000:1000"
    restart: on-failure
    environment:
      <<: *env
    volumes:
      - ${APP_DATA_DIR}/data/rabbitmq:/var/lib/rabbitmq

  minio:
    image: alpine/minio:RELEASE.2025-10-15T17-29-55Z@sha256:cf23643a6cf9ce159c57643ceb88279e431262282428c9e0bf3a7ef1a97e84b4
    user: "1000:1000"
    restart: on-failure
    command: server /export --console-address ":8763"
    environment:
      <<: *env
    volumes:
      - ${APP_DATA_DIR}/data/uploads:/export
    ports:
      - "8763:8763"
    # fails to connect if name contains underscore
    container_name: plane-minio-1

  api:
    image: makeplane/plane-backend:v1.1.0@sha256:5ceabae0ae6434d1d1e60eebe039693e2453c6b559727b577b7f750bbd34c53f
    user: "1000:1000"
    restart: on-failure
    environment:
      <<: *env
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
      rabbitmq:
        condition: service_started

  worker:
    image: makeplane/plane-backend:v1.1.0@sha256:5ceabae0ae6434d1d1e60eebe039693e2453c6b559727b577b7f750bbd34c53f
    user: "1000:1000"
    restart: on-failure
    environment:
      <<: *env
    depends_on:
      api:
        condition: service_started
      redis:
        condition: service_started
      rabbitmq:
        condition: service_started
    command: ["sh","-c","celery -A plane worker --loglevel=info"]

  beat-worker:
    image: makeplane/plane-backend:v1.1.0@sha256:5ceabae0ae6434d1d1e60eebe039693e2453c6b559727b577b7f750bbd34c53f
    user: "1000:1000"
    restart: on-failure
    environment:
      <<: *env
    depends_on:
      api:
        condition: service_started
      redis:
        condition: service_started
      rabbitmq:
        condition: service_started
      migrator:
        condition: service_completed_successfully
    command: ["sh","-c","celery -A plane beat --loglevel=info"]

  migrator:
    image: makeplane/plane-backend:v1.1.0@sha256:5ceabae0ae6434d1d1e60eebe039693e2453c6b559727b577b7f750bbd34c53f
    user: "1000:1000"
    restart: on-failure
    environment:
      <<: *env
    depends_on:
      db:
        condition: service_healthy
    command: ["sh","-c","python manage.py wait_for_db && python manage.py migrate"]

  web:
    image: makeplane/plane-frontend:v1.1.0@sha256:cd66043932d0872527ae186b7ad35d26c5deca67881c4bed3a2f1d5f183b6026
    user: "1000:1000"
    restart: on-failure
    environment:
      <<: *env
    depends_on:
      - api

  live:
    image: makeplane/plane-live:v1.1.0@sha256:fc12847a8feb2de4c7b70459502bb232d81ca4b901284744d738e42363907dcf
    user: "1000:1000"
    restart: on-failure
    environment:
      <<: *env
    depends_on:
      - api

  space:
    image: makeplane/plane-space:v1.1.0@sha256:b97ff9529fcc742211c73844f574193357a9784137b474b79e0df917e7357539
    user: "1000:1000"
    restart: on-failure
    environment:
      <<: *env
    depends_on:
      - api

  admin:
    image: makeplane/plane-admin:v1.1.0@sha256:170fdf392c7e9eb6bfc718922f54a81cdb9c97ff94de114b254340b0c404416c
    user: "1000:1000"
    restart: on-failure
    environment:
      <<: *env
    depends_on:
      - api
