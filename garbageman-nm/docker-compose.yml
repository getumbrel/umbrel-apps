version: "3.7"

services:
  app_proxy:
    environment:
      APP_HOST: garbageman-nm_app_1
      APP_PORT: 5173

  app:
    image: paulscode/garbageman-nm:0.2.2.0@sha256:b1990dfdef41c49cd0d87b2364d90642b5e2a0a550cc8956cea425cb9260ac4c
    restart: on-failure
    
    # Allow 1 minute for graceful shutdown (important for Bitcoin daemons)
    stop_grace_period: 1m
    
    # Ports exposed for internal services only
    # Web UI (5173) is proxied through app_proxy
    # API and Supervisor ports kept for potential future use
    
    volumes:
      # APP_DATA_DIR is provided by Umbrel (typically ~/umbrel/app-data/garbageman-nm)
      # All data is persisted across container restarts and updates
      - ${APP_DATA_DIR}/bitcoin:/data/bitcoin      # Bitcoin daemon data directories
      - ${APP_DATA_DIR}/envfiles:/data/envfiles    # Instance configuration files
      - ${APP_DATA_DIR}/artifacts:/data/artifacts  # Downloaded binaries/blockchains
      - ${APP_DATA_DIR}/tor:/data/tor              # Tor hidden service keys
    
    environment:
      # Tor Configuration
      # This app runs its own internal Tor daemon (NOT Umbrel's Tor proxy)
      # The internal daemon is used for .onion peer discovery and hidden services
      TOR_PROXY_HOST: "127.0.0.1"  # Localhost - Tor daemon runs in same container
      TOR_PROXY_PORT: "9050"       # Standard Tor SOCKS port
      
      # Umbrel Integration Variables
      # These are automatically provided by Umbrel at runtime
      APP_DATA_DIR: ${APP_DATA_DIR}              # Data directory path (for wrapper detection)
      APP_HIDDEN_SERVICE: ${APP_HIDDEN_SERVICE}  # This app's .onion address (optional)
      DEVICE_HOSTNAME: ${DEVICE_HOSTNAME}        # Umbrel hostname (e.g., umbrel.local)
      
      # WebUI Authentication
      # Using static default password for initial release
      # Future release will add in-app password management with forced password change
      ADMIN_PASSWORD: garbageman               # Default WebUI login password
    
    networks:
      default:
        # Static IP address on Umbrel's private network
        # APP_GARBAGEMAN_NM_IP is exported from exports.sh (10.21.21.201)
        ipv4_address: $APP_GARBAGEMAN_NM_IP
