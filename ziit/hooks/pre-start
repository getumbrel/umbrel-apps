#!/usr/bin/env bash
set -e

APP_DIR="$(readlink -f "$(dirname "${BASH_SOURCE[0]}")/..")"
ENV_FILE="$APP_DIR/docker-compose.yml"

if [ ! -f "$ENV_FILE" ]; then
    echo "Error: $ENV_FILE does not exist"
    exit 1
fi

CURRENT_PASETO=$(grep -E '^\s*NUXT_PASETO_KEY:' "$ENV_FILE" | sed -E 's/.*"k4\.local\.([^"]+)".*/\1/' | xargs)

CURRENT_PASSWORD=$(grep -E '^\s*POSTGRES_PASSWORD:' "$ENV_FILE" | sed -E 's/.*POSTGRES_PASSWORD:\s*([^#\s]+).*/\1/' | xargs)

if [[ "$CURRENT_PASETO" == "CHANGEME" ]] || [[ "$CURRENT_PASETO" == "OUTPUT_OF_OPENSSL_COMMAND" ]] || [[ "$CURRENT_PASETO" == *"CHANGEME"* ]] || [[ "$CURRENT_PASETO" == *"OUTPUT_OF_OPENSSL_COMMAND"* ]]; then
    NEW_PASETO_KEY=$(openssl rand -base64 32)
    sed -i '' -E 's|^( *NUXT_PASETO_KEY: *).*$|\1"k4.local.'$NEW_PASETO_KEY'"|' "$ENV_FILE"
fi

if [[ "$CURRENT_PASSWORD" == "CHANGEME" ]] || [[ "$CURRENT_PASSWORD" == "OUTPUT_OF_OPENSSL_COMMAND" ]]; then
    NEW_PASSWORD=$(openssl rand -hex 16)
    sed -i '' -E 's|^( *POSTGRES_PASSWORD: *).*$|\1'$NEW_PASSWORD'|' "$ENV_FILE"
    
    sed -i '' -E "s|^( *NUXT_DATABASE_URL: *).*(#.*)?$|\1\"postgresql://postgres:$NEW_PASSWORD@postgres:5432/ziit\"\2|" "$ENV_FILE"
fi