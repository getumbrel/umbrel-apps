version: "3.7"

services:
  app_proxy:
    environment:
      APP_HOST: pogolo_dozzle_1
      APP_PORT: 5663

  dozzle:
    image: amir20/dozzle:v9@sha256:2d59d09503f2c947133a4f231fdeb1f4c99e23aa0d4137f81bb1a6318e0e06cf
    restart: on-failure
    stop_grace_period: 30s
    # needs to be root
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      DOZZLE_FILTER: label=logopo
      DOZZLE_ADDR: :5663

  pogolo:
    image: 0xf0xx0/pogolo:v1.0.0@sha256:6ac54348acea6ef327bdb5f07b2a0dec1959ee31428b8e501fd2b86a663f504f
    restart: on-failure
    user: "1000:1000"
    stop_grace_period: 30s
    labels:
      - logopo
    ports:
      - 5661:5661 # stratum
      - 5662:5662 # api
    volumes:
      - "${APP_DATA_DIR}/data:/config:ro"
    environment:
      POGOLO_HOST: "0.0.0.0"
      POGOLO_BACKEND_HOST: "$APP_BITCOIN_NODE_IP:$APP_BITCOIN_RPC_PORT"
      POGOLO_BACKEND_AUTH: "$APP_BITCOIN_RPC_USER:$APP_BITCOIN_RPC_PASS"
      # colorful logs
      FORCE_COLOR: 1

  widget-server:
    image: 0xf0xx0/umbrel-pogolo-widget:v1.0.0@sha256:4355198345deb2b6c7f6f38ad9ef5e91e3fbdc5e13d5465446fe89c968ecf852
    restart: on-failure
    user: "1000:1000"
    environment:
      POGOLO_API_URL: "http://pogolo_pogolo_1:5662"
