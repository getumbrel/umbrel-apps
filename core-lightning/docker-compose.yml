version: "3.8"

services:
  app_proxy:
    environment:
      APP_HOST: $APP_CORE_LIGHTNING_IP
      APP_PORT: $APP_CORE_LIGHTNING_PORT

  app:
    build:
      dockerfile: ${APP_DATA_DIR}/src/Dockerfile
      context: ${APP_DATA_DIR}/src
    command: npm run dev:backend
    restart: on-failure
    volumes:
      - ${APP_DATA_DIR}/data/lightningd:/lightningd
      - "${APP_CORE_LIGHTNING_REST_CERT_DIR}:/c-lightning-rest/certs"
    environment:
      PORT: "${APP_CORE_LIGHTNING_PORT}"
      LIGHTNING_HOST: ${APP_CORE_LIGHTNING_DAEMON_IP}
      LIGHTNING_NETWORK: bitcoin
      LIGHTNING_GRPC_PORT: ${APP_CORE_LIGHTNING_DAEMON_GRPC_PORT}
      LIGHTNING_REST_PORT: ${APP_CORE_LIGHTNING_REST_PORT}
      LIGHTNING_REST_MACAROON_PATH: "/c-lightning-rest/certs/access.macaroon"
      LIGHTNING_REST_HIDDEN_SERVICE: http://${APP_CORE_LIGHTNING_REST_HIDDEN_SERVICE}
      LOCAL_HOST: http://${DEVICE_DOMAIN_NAME}
      CA_CERT: /lightningd/bitcoin/ca.pem
      CLIENT_KEY: /lightningd/bitcoin/client-key.pem
      CLIENT_CERT: /lightningd/bitcoin/client.pem
    networks:
      default:
        ipv4_address: ${APP_CORE_LIGHTNING_IP}
  
  c-lightning-rest:
    image: saubyk/c-lightning-rest:0.7.2
    restart: on-failure
    ports:
      - ${APP_CORE_LIGHTNING_REST_PORT}:${APP_CORE_LIGHTNING_REST_PORT}
    environment:
      PORT: "${APP_CORE_LIGHTNING_REST_PORT}"
      PROTOCOL: "http"
    volumes:
      - "${APP_CORE_LIGHTNING_REST_CERT_DIR}:/usr/src/app/certs"
      - "${APP_DATA_DIR}/data/lightningd:/root/.lightning"
    networks:
      default:
        ipv4_address: ${APP_CORE_LIGHTNING_REST_IP}

  lightningd:
    image: elementsproject/lightningd:v0.11.1
    restart: on-failure
    ports:
      - ${APP_CORE_LIGHTNING_DAEMON_PORT}:9735
    command:
      - --bitcoin-rpcconnect=${APP_BITCOIN_NODE_IP}
      - --bitcoin-rpcuser=${APP_BITCOIN_RPC_USER}
      - --bitcoin-rpcpassword=${APP_BITCOIN_RPC_PASS}
      - --proxy=${TOR_PROXY_IP}:${TOR_PROXY_PORT}
      - --bind-addr=${APP_CORE_LIGHTNING_DAEMON_IP}:9735
      - --addr=statictor:${TOR_PROXY_IP}:29051
      - --tor-service-password=${TOR_PASSWORD}
      - --grpc-port=${APP_CORE_LIGHTNING_DAEMON_GRPC_PORT}
    volumes:
      - "${APP_DATA_DIR}/data/lightningd:/root/.lightning"
    networks:
      default:
        ipv4_address: ${APP_CORE_LIGHTNING_DAEMON_IP}