version: '3.7'

services:
  app_proxy:
    environment:
      APP_HOST: sure_web_1
      APP_PORT: 3000

  web:
    image: ghcr.io/we-promise/sure:0.6.7-rc.1@sha256:28637b6cb59b073511516e5ab7b71f0d760e00c6755b331ef7ee93f729020205
    volumes:
      - ${APP_DATA_DIR}/data/rails:/rails/storage
    restart: on-failure
    environment:
      POSTGRES_USER: sure_user
      POSTGRES_PASSWORD: sure_password
      POSTGRES_DB: sure_production
      SECRET_KEY_BASE: $APP_SEED
      SELF_HOSTED: "true"
      RAILS_FORCE_SSL: "false"
      RAILS_ASSUME_SSL: "false"
      DB_HOST: sure_db_1
      DB_PORT: 5432
      REDIS_URL: redis://sure_redis_1:6379/1
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

  worker:
    image: ghcr.io/we-promise/sure:0.6.7-rc.1@sha256:28637b6cb59b073511516e5ab7b71f0d760e00c6755b331ef7ee93f729020205
    command: bundle exec sidekiq
    volumes:
      - ${APP_DATA_DIR}/data/rails:/rails/storage
    restart: on-failure
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      POSTGRES_USER: sure_user
      POSTGRES_PASSWORD: sure_password
      POSTGRES_DB: sure_production
      SECRET_KEY_BASE: $APP_SEED
      SELF_HOSTED: "true"
      RAILS_FORCE_SSL: "false"
      RAILS_ASSUME_SSL: "false"
      DB_HOST: sure_db_1
      DB_PORT: 5432
      REDIS_URL: redis://sure_redis_1:6379/1

  db:
    image: postgres:18.1-alpine@sha256:eca6fb2d91fda290eb8cfb8ba53dd0dcbf3508a08011e30adb039ea7c8e1e9f2
    restart: on-failure
    volumes:
      - ${APP_DATA_DIR}/data/postgres:/data
    environment:
      POSTGRES_USER: sure_user
      POSTGRES_PASSWORD: sure_password
      POSTGRES_DB: sure_production
      PGDATA: /data/pgdata
    healthcheck:
      test: "pg_isready -U sure_user -h localhost -d sure_production"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    image: redis:8.4.0@sha256:73dad4271642c5966db88db7a7585fae7cf10b685d1e48006f31e0294c29fdd7
    restart: on-failure
    volumes:
      - ${APP_DATA_DIR}/data/redis:/data
    healthcheck:
      test: redis-cli ping
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 30s
