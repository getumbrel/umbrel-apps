version: "3.7"

services:
  app_proxy:
    environment:
      APP_HOST: $APP_PASSKY_SERVER_IP
      APP_PORT: $APP_PASSKY_SERVER_PORT
      PROXY_AUTH_ADD: "false"

  database:
    image: 'rabbitcompany/passky-database:v7.0.0'
    restart: on-failure
    stop_grace_period: 1m
    environment:
      # Database
      - MYSQL_DATABASE: passky
      - MYSQL_USER: passky
      - MYSQL_PASSWORD: "${APP_PASSWORD}"
      - MYSQL_ROOT_PASSWORD: "${APP_PASSWORD}"
      # Backup
      - BACKUP_ENABLED: false
    volumes:
      - ${APP_DATA_DIR}/data/passky:/var/lib/mysql
    networks:
      default:
        ipv4_address: $APP_PASSKY_DB_IP

  api:
    image: 'rabbitcompany/passky-api:v7.0.0'
    restart: on-failure
    stop_grace_period: 1m
    ports:
      - 80:80
    environment:
      # Server
      - SERVER_LOCATION: US
      - SERVER_CORES: 1
      # Admin Panel
      - ADMIN_USERNAME: admin
      - ADMIN_PASSWORD: "${APP_PASSWORD}"
      # Database
      - MYSQL_HOST: "${APP_PASSKY_DB_IP}"
      - MYSQL_DATABASE: passky
      - MYSQL_USER: passky
      - MYSQL_PASSWORD: "${APP_PASSWORD}"
      # Mail
      - MAIL_ENABLED: false
      # Account
      - ACCOUNT_MAX: 100
      - ACCOUNT_MAX_PASSWORDS: 1000
      # YUBICO
      - YUBI_CLOUD: https://api.yubico.com/wsapi/2.0/verify
      - YUBI_ID: 67857
      # Limiter
      - LIMITER_ENABLED: true
      - LIMITER_GET_INFO: 1
      - LIMITER_GET_STATS: 1
      - LIMITER_GET_TOKEN: 3
      - LIMITER_GET_PASSWORDS: 2
      - LIMITER_SAVE_PASSWORD: 2
      - LIMITER_EDIT_PASSWORD: 2
      - LIMITER_DELETE_PASSWORD: 2
      - LIMITER_CREATE_ACCOUNT: 10
      - LIMITER_DELETE_ACCOUNT: 10
      - LIMITER_IMPORT_PASSWORDS: 10
      - LIMITER_FORGOT_USERNAME: 60
      - LIMITER_ENABLE_2FA: 10
      - LIMITER_DISABLE_2FA: 10
      - LIMITER_ADD_YUBIKEY: 10
      - LIMITER_REMOVE_YUBIKEY: 10
    networks:
      default:
        ipv4_address: $APP_PASSKY_SERVER_IP
