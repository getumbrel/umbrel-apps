version: "3.7"

services:
  app_proxy:
    environment:
      APP_HOST: monetr_monetr_1
      APP_PORT: 4000

  postgres:
    image: postgres:17@sha256:f337b026cb1fb954a93f2e33a62bf9ea7fffc1dafc1586c53b93922a8d6ee018
    environment:
      POSTGRES_PASSWORD: m0netrPass123
      POSTGRES_USER: postgres
      POSTGRES_DB: monetr
    volumes:
      - ${APP_DATA_DIR}/data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  valkey:
    image: valkey/valkey:9@sha256:4503e204c900a00ad393bec83c8c7c4c76b0529cd629e23b34b52011aefd1d27
    volumes:
      - ${APP_DATA_DIR}/data/valkey:/data
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10

  monetr:
    image: ghcr.io/monetr/monetr:1.7.0@sha256:d219a28c86eb2af3a42a0c3b357accd25d44a48b03b4ba2cdaeb99715d40c4ca
    user: "1000:1000"
    command:
      - serve
      - --migrate
      - --generate-certificates
    depends_on:
      postgres:
        condition: service_healthy
      valkey:
        condition: service_healthy
    volumes:
      - ${APP_DATA_DIR}/data/app:/etc/monetr
    environment:
      MONETR_ALLOW_SIGN_UP: ${MONETR_ALLOW_SIGN_UP:-true}
      MONETR_PG_USERNAME: postgres
      MONETR_PG_PASSWORD: m0netrPass123
      MONETR_PG_DATABASE: monetr
      MONETR_PG_ADDRESS: monetr_postgres_1
      MONETR_PG_PORT: 5432
      MONETR_REDIS_ENABLED: "true"
      MONETR_REDIS_ADDRESS: monetr_valkey_1
      MONETR_REDIS_PORT: 6379
      MONETR_STORAGE_ENABLED: ${MONETR_STORAGE_ENABLED:-true}
      MONETR_STORAGE_PROVIDER: ${MONETR_STORAGE_PROVIDER:-filesystem}

