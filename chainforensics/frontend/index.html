<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChainForensics - Blockchain Analysis Dashboard</title>
    <!-- External Libraries -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

    <!-- Modular CSS -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/visualization.css">
</head>
<body>
    <header class="header">
        <div class="logo">
            <span class="logo-icon">ğŸ”—</span>
            <span>ChainForensics</span>
            <div class="status-badge" style="margin-left: 12px; font-size: 0.75rem; padding: 4px 12px;">
                <span style="color: var(--accent-blue);">v1.2.0</span>
            </div>
        </div>
        <div class="header-right">
            <div class="status-badge">
                <div class="status-dot" id="status-dot"></div>
                <span id="status-text">Bitcoin Node: Connecting...</span>
            </div>
        </div>
    </header>
    <div class="main-container">
        <aside class="sidebar">
            <!-- KYC Privacy Check - First -->
            <div class="sidebar-section kyc-check collapsed" id="section-kyc">
                <div class="sidebar-title" onclick="toggleSection('section-kyc')">
                    <span class="sidebar-title-icon">ğŸ•µï¸</span>KYC Privacy Check
                    <span class="help-icon" onclick="event.stopPropagation()">?<span class="tooltip"><span class="tooltip-title">KYC Privacy Check</span>Check if your Bitcoin withdrawal from a KYC exchange (Coinbase, Kraken, etc.) can be traced to your current holdings. This simulates what an adversary who knows your exchange withdrawal could discover about where your funds are now.</span></span>
                    <span class="collapse-icon">â–¼</span>
                </div>
                <div class="sidebar-content">
                    <div class="input-group"><label for="kyc-txid">Exchange Withdrawal TX <span class="help-icon">?<span class="tooltip">The transaction ID from your exchange withdrawal. Find this in your exchange's transaction history.</span></span></label><input type="text" id="kyc-txid" placeholder="Enter txid..." /></div>
                    <div class="input-group"><label for="kyc-address">Your Withdrawal Address <span class="help-icon">?<span class="tooltip">The Bitcoin address you withdrew to from the exchange. This is your receiving address.</span></span></label><input type="text" id="kyc-address" placeholder="Enter an address..." /></div>
                    <div class="input-group"><label for="kyc-depth">Scan Depth <span class="help-icon">?<span class="tooltip">How deep to trace transactions. Higher depths find more connections but take longer. Quick=3 hops, Standard=6 hops, Deep=10 hops, Thorough=15 hops.</span></span></label><select id="kyc-depth"><option value="quick">Quick Scan (3 hops)</option><option value="standard" selected>Standard (6 hops)</option><option value="deep">Deep Scan (10 hops)</option><option value="thorough">Thorough (15 hops)</option></select></div>
                    <button class="btn btn-kyc" onclick="runKYCPrivacyCheck()">ğŸ•µï¸ Check My Privacy</button>
                </div>
            </div>

            <!-- Cluster Detection - New -->
            <div class="sidebar-section cluster-detection collapsed" id="section-cluster">
                <div class="sidebar-title" onclick="toggleSection('section-cluster')">
                    <span class="sidebar-title-icon">ğŸ”—</span>Cluster Detection
                    <span class="help-icon" onclick="event.stopPropagation()">?<span class="tooltip"><span class="tooltip-title">Cluster Detection</span>Detects if your Bitcoin addresses are linked together using Common Input Ownership Heuristic (CIOH). When you spend from multiple addresses in one transaction, they become linked and can be attributed to the same owner.</span></span>
                    <span class="collapse-icon">â–¼</span>
                </div>
                <div class="sidebar-content">
                    <div class="input-group"><label for="cluster-address">Bitcoin Address <span class="help-icon">?<span class="tooltip">Enter any of your Bitcoin addresses to see if it's linked to other addresses through common input spending.</span></span></label><input type="text" id="cluster-address" placeholder="Enter an address..." /></div>
                    <div class="input-group"><label for="cluster-depth">Analysis Depth <span class="help-icon">?<span class="tooltip">How many levels of connections to explore. Higher values find more linked addresses but take longer.</span></span></label><select id="cluster-depth"><option value="2">Quick (2 levels)</option><option value="3" selected>Standard (3 levels)</option><option value="4">Deep (4 levels)</option></select></div>
                    <button class="btn btn-primary" style="background: linear-gradient(135deg, var(--accent-purple), #9333ea);" onclick="detectCluster()">ğŸ”— Detect Linked Addresses</button>
                </div>
            </div>

            <!-- Exchange Proximity - New -->
            <div class="sidebar-section exchange-proximity collapsed" id="section-exchange">
                <div class="sidebar-title" onclick="toggleSection('section-exchange')">
                    <span class="sidebar-title-icon">ğŸ¦</span>Exchange Proximity
                    <span class="help-icon" onclick="event.stopPropagation()">?<span class="tooltip"><span class="tooltip-title">Exchange Proximity</span>Measures how many transaction "hops" separate your address from known exchange addresses (Binance, Coinbase, Kraken, etc.). Addresses close to exchanges are easily KYC-linked by chain analysis firms.</span></span>
                    <span class="collapse-icon">â–¼</span>
                </div>
                <div class="sidebar-content">
                    <div class="input-group"><label for="exchange-address">Bitcoin Address <span class="help-icon">?<span class="tooltip">Enter an address to check how close it is to known exchange wallets.</span></span></label><input type="text" id="exchange-address" placeholder="Enter an address..." /></div>
                    <div class="input-group"><label for="exchange-hops">Max Hops to Search <span class="help-icon">?<span class="tooltip">How many transaction hops to search for exchange connections. More hops = more thorough but slower.</span></span></label><select id="exchange-hops"><option value="3">Quick (3 hops)</option><option value="6" selected>Standard (6 hops)</option><option value="10">Deep (10 hops)</option></select></div>
                    <button class="btn btn-primary" style="background: linear-gradient(135deg, var(--accent-red), #dc2626);" onclick="analyzeExchangeProximity()">ğŸ¦ Check Exchange Distance</button>
                </div>
            </div>

            <!-- UTXO Privacy Rating - New -->
            <div class="sidebar-section utxo-privacy collapsed" id="section-utxo-privacy">
                <div class="sidebar-title" onclick="toggleSection('section-utxo-privacy')">
                    <span class="sidebar-title-icon">ğŸ›¡ï¸</span>UTXO Privacy Rating
                    <span class="help-icon" onclick="event.stopPropagation()">?<span class="tooltip"><span class="tooltip-title">UTXO Privacy Rating</span>Analyzes each UTXO (unspent coin) at an address and rates its privacy level as Red (high risk), Yellow (medium risk), or Green (low risk). Helps you understand which coins to use carefully.</span></span>
                    <span class="collapse-icon">â–¼</span>
                </div>
                <div class="sidebar-content">
                    <div class="input-group"><label for="utxo-privacy-address">Bitcoin Address <span class="help-icon">?<span class="tooltip">Enter an address to analyze the privacy level of each UTXO it holds.</span></span></label><input type="text" id="utxo-privacy-address" placeholder="Enter an address..." /></div>
                    <button class="btn btn-primary" style="background: linear-gradient(135deg, var(--accent-green), #059669);" onclick="analyzeUTXOPrivacy()">ğŸ›¡ï¸ Rate My UTXOs</button>
                </div>
            </div>

            <!-- Transaction Analysis -->
            <div class="sidebar-section tx-analysis collapsed" id="section-tx">
                <div class="sidebar-title" onclick="toggleSection('section-tx')">
                    <span class="sidebar-title-icon">ğŸ”</span>Transaction Analysis
                    <span class="help-icon" onclick="event.stopPropagation()">?<span class="tooltip"><span class="tooltip-title">Transaction Analysis</span>Examine any Bitcoin transaction in detail. Enter a TXID to see inputs, outputs, fees, confirmations, and detect potential CoinJoin activity.</span></span>
                    <span class="collapse-icon">â–¼</span>
                </div>
                <div class="sidebar-content">
                    <div class="input-group">
                        <label for="txid-input">Transaction ID <span class="help-icon">?<span class="tooltip"><span class="tooltip-title">Transaction ID (TXID)</span>The unique 64-character hexadecimal identifier for a Bitcoin transaction.</span></span></label>
                        <input type="text" id="txid-input" placeholder="Enter txid..." />
                    </div>
                    <div class="input-group">
                        <label for="vout-input">Output Index (vout) <span class="help-icon">?<span class="tooltip"><span class="tooltip-title">Output Index</span>Which specific output to analyze. Index starts at 0.</span></span></label>
                        <input type="number" id="vout-input" value="0" min="0" />
                    </div>
                    <button class="btn btn-primary" onclick="analyzeTransaction()">ğŸ” Analyze Transaction</button>
                    
                    <div class="subsection-divider"></div>
                    <div class="subsection-title"><span>ğŸ”</span> UTXO Tracing</div>
                    <div class="input-group"><label for="trace-direction">Direction</label><select id="trace-direction"><option value="forward">Forward (where did it go?)</option><option value="backward">Backward (where did it come from?)</option></select></div>
                    <div class="input-group"><label for="trace-depth">Max Depth</label><input type="number" id="trace-depth" value="10" min="1" max="50" /></div>
                    <button class="btn btn-primary" onclick="traceUTXO()">ğŸ” Trace UTXO</button>
                    
                    <div class="subsection-divider"></div>
                    <div class="subsection-title"><span>âš¡</span> Quick Actions</div>
                    <button class="btn btn-secondary" onclick="detectCoinJoin()" style="margin-bottom: 8px;">ğŸ”€ Detect CoinJoin</button>
                    <button class="btn btn-secondary" onclick="calculatePrivacy()">ğŸ›¡ï¸ Privacy Score</button>
                </div>
            </div>

            <!-- Address Lookup -->
            <div class="sidebar-section address-lookup collapsed" id="section-address">
                <div class="sidebar-title" onclick="toggleSection('section-address')">
                    <span class="sidebar-title-icon">ğŸ“</span>Address Lookup
                    <span class="help-icon" onclick="event.stopPropagation()">?<span class="tooltip"><span class="tooltip-title">Address Lookup</span><b>Get Balance & UTXOs:</b> See current balance and unspent outputs.<br><br><b>Check Dust Attack:</b> Detect suspicious tiny UTXOs.<br><br><b>Validate Address:</b> Verify address format.</span></span>
                    <span class="collapse-icon">â–¼</span>
                </div>
                <div class="sidebar-content">
                    <div class="input-group"><label for="address-input">Bitcoin Address</label><input type="text" id="address-input" placeholder="Enter an address..." /></div>
                    <button class="btn btn-secondary" onclick="getAddressInfo()" style="margin-bottom: 8px;">ğŸ’° Get Balance & UTXOs</button>
                    <button class="btn btn-secondary" onclick="checkDustAttack()" style="margin-bottom: 8px;">ğŸ”¬ Check Dust Attack</button>
                    <button class="btn btn-secondary" onclick="validateAddress()">âœ“ Validate Address</button>
                </div>
            </div>

            <!-- Label Manager -->
            <div class="sidebar-section label-manager collapsed" id="section-labels">
                <div class="sidebar-title" onclick="toggleSection('section-labels')">
                    <span class="sidebar-title-icon">ğŸ“</span>Label Manager
                    <span class="help-icon" onclick="event.stopPropagation()">?<span class="tooltip"><span class="tooltip-title">Label Manager</span>View, add, edit, and delete custom labels for Bitcoin addresses. Organize addresses into categories (Personal, Exchange, Merchant, Mixer, Other) with optional notes.</span></span>
                    <span class="collapse-icon">â–¼</span>
                </div>
                <div class="sidebar-content">
                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 12px;">Manage your saved address labels. Search, filter, add, edit, or delete labels to organize and categorize Bitcoin addresses.</p>
                    <button class="btn btn-primary" style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));" onclick="loadLabels()">ğŸ“ View All Labels</button>
                </div>
            </div>

            <!-- Support - Always last, no collapse -->
            <div class="sidebar-section support">
                <div class="sidebar-title"><span class="sidebar-title-icon">ğŸ’</span>Support</div>
                <button class="btn btn-donate" onclick="openDonationModal()">ğŸº Buy me a Drink</button>
            </div>
        </aside>
        <main class="content">
            <div class="stats-grid" id="stats-grid">
                <div class="stat-card"><div class="stat-value" id="block-height">-</div><div class="stat-label">Block Height</div></div>
                <div class="stat-card"><div class="stat-value" id="chain-type">-</div><div class="stat-label">Network</div></div>
                <div class="stat-card"><div class="stat-value" id="sync-progress">-</div><div class="stat-label">Sync Progress</div></div>
                <div class="stat-card"><div class="stat-value" id="api-status">-</div><div class="stat-label">API Status</div></div>
                <div class="stat-card"><div class="stat-value" id="fulcrum-status">-</div><div class="stat-label">Fulcrum</div><div id="fulcrum-warning" style="display:none; font-size: 10px; color: var(--accent-orange); margin-top: 4px;"></div></div>
            </div>
            <div id="results-container">
                <div class="card"><div class="card-header"><div class="card-title">ğŸ“‹ Analysis Results</div></div><div class="card-body"><p style="color: var(--text-secondary); text-align: center; padding: 40px;">Enter a transaction ID and click "Analyze Transaction" to begin,<br>or use the <strong>KYC Privacy Check</strong> to see if your exchange withdrawal can be traced.</p></div></div>
            </div>
        </main>
    </div>
    <div class="modal-overlay" id="donation-modal">
        <div class="modal">
            <button class="modal-close" onclick="closeDonationModal()">Ã—</button>
            <div class="modal-title">ğŸº Buy me a Drink</div>
            <div class="qr-container"><img src="qr-code.png" alt="Bitcoin Donation QR Code" id="qr-image" /></div>
            <p style="color: var(--text-secondary); margin-bottom: 12px;">This is the way:</p>
            <div class="donation-address" id="donation-address">bc1q9k7xdqg6cc4lvmwpkygecg3yjwxndda0vctua9</div>
            <button class="copy-btn" onclick="copyAddress()" id="copy-btn">ğŸ“‹ Copy Address</button>
            <div class="modal-footer">Thank you for your support! ğŸ™</div>
        </div>
    </div>
    <!-- Main Application Module -->
    <script type="module" src="js/app.js"></script>

    
    <!-- Visualization Modal -->
    <div class="vis-modal" id="vis-modal">
        <div class="vis-modal-header">
            <div class="vis-modal-title">
                <span>ğŸ”—</span>
                <span id="vis-modal-title-text">Transaction Flow Visualization</span>
            </div>
            <div class="vis-controls">
                <button class="vis-control-btn" onclick="visZoomIn()">â• Zoom In</button>
                <button class="vis-control-btn" onclick="visZoomOut()">â– Zoom Out</button>
                <button class="vis-control-btn" onclick="visFitAll()">â›¶ Fit All</button>
                <button class="vis-modal-close" onclick="closeVisualization()">âœ• Close</button>
            </div>
        </div>
        <div class="vis-modal-body">
            <div class="vis-container" id="vis-container"></div>
            <div class="vis-sidebar">
                <div class="vis-stats">
                    <div class="vis-stats-title">ğŸ“Š Flow Statistics</div>
                    <div class="vis-stats-grid">
                        <div class="vis-stat">
                            <div class="vis-stat-value" id="vis-stat-nodes">0</div>
                            <div class="vis-stat-label">Nodes</div>
                        </div>
                        <div class="vis-stat">
                            <div class="vis-stat-value" id="vis-stat-edges">0</div>
                            <div class="vis-stat-label">Flows</div>
                        </div>
                        <div class="vis-stat">
                            <div class="vis-stat-value" id="vis-stat-depth">0</div>
                            <div class="vis-stat-label">Max Depth</div>
                        </div>
                        <div class="vis-stat">
                            <div class="vis-stat-value" id="vis-stat-value">0</div>
                            <div class="vis-stat-label">Total BTC</div>
                        </div>
                    </div>
                </div>
                <div class="vis-legend">
                    <div class="vis-legend-title">ğŸ¨ Legend</div>
                    <div class="vis-legend-item"><div class="vis-legend-color start"></div><span>Starting Point</span></div>
                    <div class="vis-legend-item"><div class="vis-legend-color spent"></div><span>Spent Output</span></div>
                    <div class="vis-legend-item"><div class="vis-legend-color unspent"></div><span>Unspent (UTXO)</span></div>
                    <div class="vis-legend-item"><div class="vis-legend-color coinbase"></div><span>Coinbase (Mining)</span></div>
                    <div class="vis-legend-item"><div class="vis-legend-color coinjoin"></div><span>CoinJoin Detected</span></div>
                </div>
                <div class="vis-node-details" id="vis-node-details">
                    <div class="vis-node-details-title">Click a node to see details</div>
                    <div id="vis-node-content" style="color: var(--text-secondary); font-size: 0.8rem;">
                        Select any node in the graph to view transaction details, address, and value information.
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>